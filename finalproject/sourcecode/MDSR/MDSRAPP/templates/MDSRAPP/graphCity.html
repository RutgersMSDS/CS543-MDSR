<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Graph World</title>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <div class="media">
        <a href="/home"><img src="https://www.universetoday.com/wp-content/uploads/2013/10/milky_way.jpg" class="align-self-start mr-3" alt="..."
                             width="{{100}}" height="{{100}}" ></a>
        <div class="media-body">
            <h2 class="mt-0">Milky Way Bulge PSF Photometry Visualization</h2>
            <h2>Graph World</h2>
        </div>
    </div>
    <style>
        .modal {
            display:    none;
            position:   fixed;
            z-index:    1000;
            top:        0;
            left:       0;
            height:     100%;
            width:      100%;
            background: rgba( 255, 255, 255, .8 )
            url('http://i.stack.imgur.com/FhHRx.gif')
            50% 50%
            no-repeat;
        }

        body.loading .modal {
            overflow: hidden;
        }

        body.loading .modal {
            display: block;
        }
        div.item {
            vertical-align: top;
            display: inline-block;
            text-align: center;
            padding: 20px;
        }

        .caption {
            display: block;
        }
    </style>
</head>
<body>
<div id="graphWaves">
    <center>
        <input id="tileNumber" type="text" name="Star Tile: " placeholder="201 to 396"/>
        <button id="tileSubmit" class="btn btn-light btn-lg">Submit</button>
        <hr>
        <div id="viewOptions" style="display: none;">
            <button id="cityView" class="btn btn-primary btn-sm active">City View</button>
            <button id="graphView" class="btn btn-secondary btn-sm">Graph View</button>
        </div>
    </center>

    <div id="cities" style="height: 1600px;display: none;">

    </div>
    <div id="graphs" style="text-align: center;height: 1600px;display: none;">

    </div></div>


</div>
{% load static %}
<script>
    $body = $("body");

    $(document).on({
        ajaxStart: function() { $body.addClass("loading");    },
        ajaxStop: function() { $body.removeClass("loading"); }
    });

    function getFragmentHeight(numberOfEdges){
        heights = [1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5 ]
        if(numberOfEdges < 10){
            return heights[0]
        } else if (numberOfEdges < 25){
            return heights[1]
        } else if (numberOfEdges < 75){
            return heights[2]
        } else if (numberOfEdges < 250){
            return heights[3]
        } else if (numberOfEdges < 750){
            return heights[4]
        } else if (numberOfEdges < 2500){
            return heights[5]
        } else if (numberOfEdges < 7500){
            return heights[6]
        } else if (numberOfEdges < 20000){
            return heights[7]
        } else if (numberOfEdges < 75000){
            return heights[8]
        } else {
            return heights[9]
        }

    }

    function getFragmentWidthHeightAndColor(numberOfNodes, numberOfEdges){
        var fragmentWidth = [2, 5, 7.5, 10, 12, 15, 17.5, 20, 22, 25]
        var fragmentColors = ['rgba(242,100,48,0.6)','rgba(255, 199, 63, 0.6)', 'rgba(181, 222, 43, 0.6)',
            'rgba(50, 165, 194, 0.6)', 'rgba(34, 85, 164, 0.6)', 'rgba(234, 81, 157, 0.6)', 'rgba(162, 5, 126, 0.5)',
            'rgba(27, 127, 65, 0.5)', 'rgba(121, 110, 178, 0.6)', 'rgba(71, 49, 152, 0.6)']
        var fragmentBorderColors = ['rgba(242,100,48,0.8)','rgba(255, 199, 63, 0.8)', 'rgba(181, 222, 43, 0.8)',
            'rgba(50, 165, 194, 0.7)', 'rgba(34, 85, 164, 0.7)', 'rgba(234, 81, 157, 0.7)', 'rgba(162, 5, 126, 0.6)',
            'rgba(27, 127, 65, 0.6)', 'rgba(121, 110, 178, 0.8)', 'rgba(71, 49, 152, 0.7)']
        var index = 0
        if(numberOfNodes < 6){
            index = 0
        } else if (numberOfNodes < 11){
            index = 1
        } else if (numberOfNodes < 26){
            index = 2
        } else if (numberOfNodes < 76){
            index = 3
        } else if (numberOfNodes < 250){
            index = 4
        } else if (numberOfNodes < 500){
            index = 5
        } else if (numberOfNodes < 2000){
            index = 6
        } else if (numberOfNodes < 5000){
            index = 7
        } else if (numberOfNodes < 7000){
            index = 8
        } else {
            index = 9
        }
        var fragmentHeight = getFragmentHeight(numberOfEdges)
        return {"color": fragmentColors[index],"borderColor": fragmentBorderColors[index], "width": fragmentWidth[index], "height": fragmentHeight}
    }

    function getTrapeziumPathString(x_array, y_array){
        pathString = ""
        pathDirs = ["M ", " L ", " H ", " L ", " Z"]
        for(i = 0; i < 4; i++) {
            pathString += pathDirs[i] + x_array[i].toString() + ", " + y_array[i]
        }
        pathString += pathDirs[4]
        return pathString
    }

    function plotWave(dataDictionary, prevDimension, buildingNumber, ref){

        var waveNumber = Object.keys(dataDictionary)[0];
        var waveData = dataDictionary[waveNumber];

        var waveEdges = waveData["edges"].length
        var waveNodes = waveData["nodes"].length
        var waveFragments = waveData["fragments"];

        var UIfragments = [];
        var UIlabels = [];
        var label_x_array = [];
        var label_y_array = [];

        for (index = 0; index < waveFragments.length; index ++){
            var x_array = [null, null, null, null]
            var y_array = [null, null, null, null]

            fragInfo = getFragmentWidthHeightAndColor(waveNodes, waveEdges);
            if(prevDimension == null){
                x_array[0] = -fragInfo.width/2;
                y_array[0] = 0;
                x_array[3] = fragInfo.width/2;
                y_array[3] = 0;
            }
            else {
                x_array[0] = prevDimension.x1;
                y_array[0] = prevDimension.y1;
                x_array[3] = prevDimension.x2;
                y_array[3] = prevDimension.y2;
            }

            x_array[1] = -fragInfo.width/2;
            y_array[1] = y_array[0] + fragInfo.height;
            x_array[2] = fragInfo.width/2;
            y_array[2] = y_array[1];

            fragmentPath = getTrapeziumPathString(x_array, y_array)

            fragmentUI = {
                type: 'path',
                path: fragmentPath,
                fillcolor: fragInfo.color,
                line: {
                    color: fragInfo.borderColor
                },
                xref: "x" + ref.toString(),
                yref: "y" + ref.toString(),
            }
            var hoverlabel = "Fragment: " + (index + 1).toString() + "\nWave: " + waveNumber + "\nBuilding: " +
                buildingNumber + "\nBrightest Stars :" + waveNodes;

            UIfragments.push(fragmentUI)
            UIlabels.push(hoverlabel)
            label_x_array.push(0)
            label_y_array.push(y_array[1] - 0.5)

            prevDimension = {
                "x1": x_array[1], "y1": y_array[1],
                "x2": x_array[2], "y2": y_array[2]
            }
        }

        return {
            "layout": UIfragments,
            "hoverlabel": UIlabels,
            "labelXArray": label_x_array,
            "labelYArray": label_y_array,
            "dimension": {
                "x1": x_array[1], "y1": y_array[1],
                "x2": x_array[2], "y2": y_array[2]
            }
        }
    }

    function plotBuilding(dataDictionary, buildingNumber, ref) {
        var UIlabels = [];
        var label_x_array = [];
        var label_y_array = [];

        var UIfragments = [];
        var dimension = null;

        for (var waveNumber in dataDictionary["data"][0]){
            waveData = dataDictionary["data"][0][waveNumber]

            waveInfo = plotWave({[waveNumber]: waveData}, dimension, buildingNumber, ref)

            dimension = waveInfo.dimension
            layout = waveInfo.layout
            hoverlabel = waveInfo.hoverlabel
            x_array = waveInfo.labelXArray
            y_array = waveInfo.labelYArray

            UIlabels = UIlabels.concat(hoverlabel)
            UIfragments = UIfragments.concat(layout)
            label_x_array = label_x_array.concat(x_array)
            label_y_array = label_y_array.concat(y_array)
        }

        return {
            "layout": UIfragments,
            "hoverlabel": UIlabels,
            "labelXArray": label_x_array,
            "labelYArray": label_y_array,
        }

    }

    function plotCities(tileNumber, citiesDataArray){

        var numberOfCities = citiesDataArray.length;

        var columnCount = 3;
        var rowCount = parseInt(numberOfCities/columnCount)
            + Math.ceil((numberOfCities % columnCount) / (columnCount - 1));

        var layout = {
            showlegend: false,
            hovermode:'closest',
            title: 'Graph City: ' + tileNumber.toString(),
            grid: {rows: rowCount, columns: columnCount, pattern: 'independent'},
            width: screen.width,
            shapes: [],
            annotations: []
        };
        var data = []

        for (var index = 0; index < numberOfCities; index++){
            buildingInfo = plotBuilding(citiesDataArray[index], index + 1, index + 1);

            var trace = {
                x: buildingInfo.labelXArray,
                y: buildingInfo.labelYArray,
                xaxis: "x"+(index+1).toString(),
                yaxis: "y"+(index+1).toString(),
                type: 'scatter',
                mode: 'markers',
                marker: {color: 'rgba(10, 10, 10, 0.6)', size: 3},
                hoverinfo: 'text',
                hovertext: buildingInfo.hoverlabel
            }

            data.push(trace)
            layout.shapes = layout.shapes.concat(buildingInfo.layout)
            layout["xaxis"+(index+1).toString()] = {
                showticklabels: false,
                autotick: false,
                showgrid: false,
                zeroline: false
            }
            layout["yaxis"+(index+1).toString()] = {
                showticklabels: false,
                autotick: false,
                showgrid: false,
                zeroline: false
            }
            var annotation = {
                x: (Math.max(...trace.x) + Math.min(...trace.x)) / 2,
                y: Math.max(...trace.y) + 2,
                xref: "x"+(index+1).toString(),
                yref: "y"+(index+1).toString(),
                text: 'Building - ' + (index + 1).toString(),
                showarrow: true,

            }
            layout.annotations.push(annotation)
        }

        Plotly.newPlot('cities', data, layout);
        $("#viewOptions").show()
        $("#cities").show()
    }

    function placeGraphImages(imageFileNamesList){
        var imageDiv = document.getElementById('graphs');
        imageDiv.innerHTML = '';

        for (var i = 0; i < imageFileNamesList.length; i++) {
            var new_div = document.createElement("div");
            new_div.className = "item";
            new_div.style.width = ((screen.availWidth / 3)).toString();

            var label = document.createElement("span");
            label.className = "caption";
            label.innerText = "Building - " + (i + 1).toString();

            var image = new Image();
            image.className = imageFileNamesList[i];
            filepath = "../static/imgs/graphs/" + imageFileNamesList[i];

            image.src = filepath;
            image.style.background = "#000000";
            image.width = ((screen.availWidth / 3) - 150).toString();
            image.height = image.width

            new_div.appendChild(label);
            new_div.appendChild(image);

            imageDiv.appendChild(new_div)
        }

    }

    //OnClick method
    function plotGraphWaves(tileNumber){

        $.ajax({
            type: "GET",
            data: { csrfmiddlewaretoken: "{{ csrf_token }}",
                'tile':tileNumber
            },
            url:"/cities",
            success: function(result) {
                data = JSON.parse(result);
                plotCities(tileNumber, data["tile"])


                $.ajax({
                    type: "GET",
                    data: { csrfmiddlewaretoken: "{{ csrf_token }}",
                        'tile':tileNumber
                    },
                    url:"/graphs",
                    success: function(result) {
                        data = JSON.parse(result);
                        placeGraphImages(data["tile"])
                    },
                    failure: function (error) {
                        alert("Unable to retrieve data. Kindly check network connection.");
                    }});
            },
            failure: function (error) {
                alert("Unable to retrieve data. Kindly check network connection.");
            }});
    }

    $("#tileSubmit").click(function(){
        $("#viewOptions").hide();
        $("#cities").hide();
        $("#graphs").hide();

        tileNumber = parseInt($("#tileNumber")[0].value)
        plotGraphWaves(tileNumber)
    });

    $("#cityView").click(function () {
        $("#graphs").hide()
        $("#cities").show();
    });

    $("#graphView").click(function () {
        $("#cities").hide()
        $("#graphs").show();
    });

</script>


<div class="modal"><!-- Place at bottom of page --></div>
</body>
</html>